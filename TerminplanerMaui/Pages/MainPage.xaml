<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="TerminplanerMaui.Pages.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:TerminplanerMaui.Converters"
    xmlns:models="clr-namespace:TerminplanerMaui.Models"
    xmlns:vm="clr-namespace:TerminplanerMaui.ViewModels"
    x:Name="MainPageRoot"
    Title="Terminplaner"
    x:DataType="vm:MainViewModel">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IsNotNullConverter x:Key="IsNotNullConverter" />
            <converters:DaysToShowConverter x:Key="DaysToShowConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <Grid Padding="20" RowDefinitions="Auto,Auto,Auto,*">

            <!--  Date Navigation  -->
            <Border
                Grid.Row="0"
                Margin="0,0,0,10"
                Padding="15"
                BackgroundColor="#667eea"
                StrokeShape="RoundRectangle 8"
                StrokeThickness="0">
                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                    <!--  Previous Day Button  -->
                    <Button
                        Grid.Column="0"
                        Padding="0"
                        BackgroundColor="#5568d3"
                        Command="{Binding GoToPreviousDayCommand}"
                        CornerRadius="5"
                        HeightRequest="40"
                        Text="â—€"
                        TextColor="White"
                        WidthRequest="50" />

                    <!--  Current Date Display  -->
                    <Label
                        Grid.Column="1"
                        FontAttributes="Bold"
                        FontSize="18"
                        HorizontalOptions="Center"
                        Text="{Binding CurrentDateDisplay}"
                        TextColor="White"
                        VerticalOptions="Center" />

                    <!--  Today Button  -->
                    <Button
                        Grid.Column="2"
                        Margin="0,0,10,0"
                        Padding="0"
                        BackgroundColor="#5568d3"
                        Command="{Binding GoToTodayCommand}"
                        CornerRadius="5"
                        HeightRequest="40"
                        Text="Heute"
                        TextColor="White"
                        WidthRequest="70" />

                    <!--  Next Day Button  -->
                    <Button
                        Grid.Column="3"
                        Padding="0"
                        BackgroundColor="#5568d3"
                        Command="{Binding GoToNextDayCommand}"
                        CornerRadius="5"
                        HeightRequest="40"
                        Text="â–¶"
                        TextColor="White"
                        WidthRequest="50" />
                </Grid>
            </Border>

            <!--  View Options  -->
            <HorizontalStackLayout
                Grid.Row="1"
                Margin="0,0,0,10"
                HorizontalOptions="Center"
                Spacing="10">
                <Label
                    FontSize="14"
                    Text="Zeige Tage:"
                    VerticalOptions="Center" />
                <Button
                    Padding="0"
                    BackgroundColor="{Binding DaysToShow, Converter={StaticResource DaysToShowConverter}, ConverterParameter=1}"
                    Command="{Binding SetDaysToShowCommand}"
                    CommandParameter="1"
                    CornerRadius="5"
                    FontSize="14"
                    HeightRequest="40"
                    Text="1"
                    TextColor="White"
                    WidthRequest="40" />
                <Button
                    Padding="0"
                    BackgroundColor="{Binding DaysToShow, Converter={StaticResource DaysToShowConverter}, ConverterParameter=3}"
                    Command="{Binding SetDaysToShowCommand}"
                    CommandParameter="3"
                    CornerRadius="5"
                    FontSize="14"
                    HeightRequest="40"
                    Text="3"
                    TextColor="White"
                    WidthRequest="40" />
                <Button
                    Padding="0"
                    BackgroundColor="{Binding DaysToShow, Converter={StaticResource DaysToShowConverter}, ConverterParameter=7}"
                    Command="{Binding SetDaysToShowCommand}"
                    CommandParameter="7"
                    CornerRadius="5"
                    FontSize="14"
                    HeightRequest="40"
                    Text="7"
                    TextColor="White"
                    WidthRequest="40" />
            </HorizontalStackLayout>

            <!--  Add Appointment Section  -->
            <VerticalStackLayout
                Grid.Row="2"
                Margin="0,0,0,20"
                Spacing="10">
                <Entry
                    Placeholder="Neuer Termin..."
                    ReturnCommand="{Binding AddAppointmentCommand}"
                    Text="{Binding NewAppointmentText}" />
                <Entry Placeholder="Kategorie (z.B. Arbeit, Privat)" Text="{Binding NewAppointmentCategory}" />
                <Label
                    FontAttributes="Bold"
                    FontSize="14"
                    Text="Farbe:"
                    TextColor="#212121" />

                <ScrollView HorizontalScrollBarVisibility="Never" Orientation="Horizontal">
                    <HorizontalStackLayout Padding="4" Spacing="8">
                        <CollectionView
                            ItemsSource="{Binding AvailableColors}"
                            SelectedItem="{Binding NewAppointmentColor}"
                            SelectionMode="Single">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout ItemSpacing="8" Orientation="Horizontal" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Border
                                        Padding="2"
                                        BackgroundColor="White"
                                        HeightRequest="50"
                                        Stroke="LightGray"
                                        StrokeShape="RoundRectangle 25"
                                        StrokeThickness="1"
                                        WidthRequest="50">
                                        <BoxView
                                            CornerRadius="20"
                                            HeightRequest="42"
                                            WidthRequest="42"
                                            Color="{Binding .}" />
                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup Name="CommonStates">
                                                <VisualState Name="Normal" />
                                                <VisualState Name="Selected">
                                                    <VisualState.Setters>
                                                        <Setter Property="Stroke" Value="Black" />
                                                        <Setter Property="Padding" Value="4" />
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </HorizontalStackLayout>
                </ScrollView>

                <!--  Date and Time Selection  -->
                <Label
                    FontAttributes="Bold"
                    FontSize="14"
                    Text="Datum und Uhrzeit:"
                    TextColor="#212121" />
                <Border
                    Padding="12"
                    BackgroundColor="White"
                    Stroke="#667eea"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="1">
                    <VerticalStackLayout Spacing="10">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                Grid.Column="0"
                                FontSize="16"
                                Text="{Binding FormattedScheduledDateTime}"
                                TextColor="#212121"
                                VerticalOptions="Center" />
                            <Button
                                Grid.Column="1"
                                Padding="12,6"
                                BackgroundColor="#667eea"
                                Command="{Binding ShowDateTimePickerCommand}"
                                CornerRadius="5"
                                FontSize="14"
                                Text="Ã„ndern"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </Grid>
                        <VerticalStackLayout IsVisible="{Binding IsDateTimePickerVisible}" Spacing="10">
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                <DatePicker
                                    Grid.Column="0"
                                    BackgroundColor="White"
                                    Date="{Binding NewAppointmentScheduledDate}"
                                    Format="dd.MM.yyyy"
                                    MaximumDate="12/31/2030"
                                    MinimumDate="01/01/2020"
                                    TextColor="Black"
                                    VerticalOptions="Center" />
                                <TimePicker
                                    Grid.Column="1"
                                    BackgroundColor="White"
                                    Format="HH:mm"
                                    TextColor="Black"
                                    Time="{Binding NewAppointmentScheduledTime}"
                                    VerticalOptions="Center" />
                            </Grid>
                            <Button
                                Padding="12,8"
                                BackgroundColor="#4caf50"
                                Command="{Binding HideDateTimePickerCommand}"
                                CornerRadius="5"
                                HorizontalOptions="Center"
                                Text="OK"
                                TextColor="White"
                                WidthRequest="100" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <Entry Placeholder="Dauer (z.B. 30 min, 1-2 Std)" Text="{Binding NewAppointmentDuration}" />
                <HorizontalStackLayout Spacing="10">
                    <CheckBox IsChecked="{Binding NewAppointmentIsOutOfHome}" />
                    <Label Text="AuÃŸer Haus / Unterwegs" VerticalOptions="Center" />
                </HorizontalStackLayout>
                <Button
                    Padding="15,10"
                    BackgroundColor="#667eea"
                    Command="{Binding AddAppointmentCommand}"
                    CornerRadius="8"
                    Text="âž• HinzufÃ¼gen"
                    TextColor="White" />

                <!--  Info Box  -->
                <Border
                    Margin="0,10,0,0"
                    Padding="15"
                    BackgroundColor="#e3f2fd"
                    Stroke="#667eea"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="1">
                    <Label TextColor="#1565c0">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span FontAttributes="Bold" Text="ðŸ’¡ " />
                                <Span FontAttributes="Bold" Text="Tipp: " />
                                <Span Text="WÃ¤hle eine Farbe durch Antippen. GrÃ¼ner Hintergrund = AuÃŸer Haus!" />
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>
                </Border>
            </VerticalStackLayout>

            <!--  Appointments List  -->
            <RefreshView
                Grid.Row="3"
                Command="{Binding LoadAppointmentsCommand}"
                IsRefreshing="{Binding IsRefreshing}">
                <CollectionView ItemsSource="{Binding Appointments}">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout
                            Padding="40"
                            HorizontalOptions="Center"
                            Spacing="20"
                            VerticalOptions="Center">
                            <Label
                                FontSize="80"
                                HorizontalOptions="Center"
                                Text="ðŸ“" />
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                HorizontalOptions="Center"
                                Text="Noch keine Termine vorhanden!" />
                            <Label
                                FontSize="14"
                                HorizontalOptions="Center"
                                Text="FÃ¼ge deinen ersten Termin hinzu, um loszulegen."
                                TextColor="Gray" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Appointment">
                            <Border
                                Margin="0,5"
                                Padding="15"
                                Shadow="{Shadow Brush=Black, Offset='2,2', Radius=4, Opacity=0.3}"
                                Stroke="#e0e0e0"
                                StrokeShape="RoundRectangle 10"
                                StrokeThickness="1">
                                <Border.Triggers>
                                    <DataTrigger Binding="{Binding IsOutOfHome}" TargetType="Border" Value="True">
                                        <Setter Property="BackgroundColor" Value="#A5D6A7" />
                                        <Setter Property="Stroke" Value="#4CAF50" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsOutOfHome}" TargetType="Border" Value="False">
                                        <Setter Property="BackgroundColor" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Grid ColumnDefinitions="10,*,Auto" ColumnSpacing="15">
                                    <BoxView Grid.Column="0" CornerRadius="5" WidthRequest="10" Color="{Binding Color}" />
                                    <VerticalStackLayout Grid.Column="1" Spacing="5">
                                        <Label FontAttributes="Bold" FontSize="18" Text="{Binding Text}" TextColor="#212121" />
                                        <Label FontSize="14" Text="{Binding Category, StringFormat='ðŸ·ï¸ {0}'}" TextColor="#424242" />
                                        <Label FontSize="14" IsVisible="{Binding ScheduledDate, Converter={StaticResource IsNotNullConverter}}" Text="{Binding ScheduledDate, StringFormat='ðŸ•’ {0:dd.MM.yyyy HH:mm} Uhr'}" TextColor="#424242" />
                                        <Label FontSize="14" IsVisible="{Binding Duration, Converter={StaticResource IsNotNullConverter}}" Text="{Binding Duration, StringFormat='â±ï¸ {0}'}" TextColor="#424242" />
                                        <Label FontAttributes="Bold" FontSize="14" IsVisible="{Binding IsOutOfHome}" Text="ðŸ“ AuÃŸer Haus" TextColor="#2E7D32" />
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="2" Spacing="5">
                                        <HorizontalStackLayout Spacing="5">
                                            <Button Padding="0" BackgroundColor="#2196F3" Command="{Binding Source={x:Reference MainPageRoot}, Path=BindingContext.MovePriorityUpCommand}" CommandParameter="{Binding .}" CornerRadius="5" HeightRequest="40" Text="â¬†ï¸" TextColor="White" WidthRequest="40" />
                                            <Button Padding="0" BackgroundColor="#2196F3" Command="{Binding Source={x:Reference MainPageRoot}, Path=BindingContext.MovePriorityDownCommand}" CommandParameter="{Binding .}" CornerRadius="5" HeightRequest="40" Text="â¬‡ï¸" TextColor="White" WidthRequest="40" />
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Spacing="5">
                                            <Button Padding="0" BackgroundColor="#4caf50" Command="{Binding Source={x:Reference MainPageRoot}, Path=BindingContext.EditAppointmentCommand}" CommandParameter="{Binding .}" CornerRadius="5" HeightRequest="40" Text="âœï¸" TextColor="White" WidthRequest="40" />
                                            <Button Padding="0" BackgroundColor="#f44336" Command="{Binding Source={x:Reference MainPageRoot}, Path=BindingContext.DeleteAppointmentCommand}" CommandParameter="{Binding .}" CornerRadius="5" HeightRequest="40" Text="ðŸ—‘ï¸" TextColor="White" WidthRequest="40" />
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>
        </Grid>
    </ScrollView>
</ContentPage>
